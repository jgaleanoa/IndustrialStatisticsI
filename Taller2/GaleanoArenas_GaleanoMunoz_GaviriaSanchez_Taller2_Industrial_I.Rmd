---
header-includes:
- \usepackage{longtable}
- \usepackage[utf8]{inputenc}
- \usepackage[spanish]{babel}\decimalpoint
- \setlength{\parindent}{1.25cm}
- \usepackage{amsmath}
- \usepackage{xcolor}
- \usepackage{cancel}
- \usepackage{array}
- \usepackage{float}
- \usepackage{multirow}
output:
  pdf_document: 
    number_sections: yes
fontsize: 12pt
papersize: letter
geometry: margin = 1in
language: "es"
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, fig.align = "center",
                      fig.height = 3.2, fig.pos = "H")
library(kableExtra)
library(knitr)
library(tidyverse)
library(qcc)
library(latex2exp)
```

```{=tex}
\input{titlepage}
\thispagestyle{empty}
\tableofcontents
\newpage
\thispagestyle{empty}
\listoffigures
\newpage
```

```{=tex}
\pagestyle{myheadings}
\setcounter{page}{4}
```

<!-- Gaviria -->

\section{Ejercicio 1}

<!-- Juanjo -->

\section{Ejercicio 2}

Se muestra la información sobre el número de remaches sin colocar
detectados en la inspección final de una serie de aviones, la
estructura de los datos es presentada a continuación

```{r Datos-EJ2}
remaches <- read.table("RemachesAviones.txt", header = T) %>% 
  arrange(Avion)

kable(head(remaches), longtable = T, booktabs = T,
      caption = "Remaches detectados en aviones",
      col.names = c("Avión inspeccionado", "Número de remaches"),
      linesep = "",
      align = "c")
```

\subsection{Gráfica de control a usar}

Teniendo en cuenta que se tiene el número **total** de remaches sin colocar en **un avión** particular y se están inspeccionando 25 aviones para los cuales la cantidad de remaches sin colocar en cada uno de ellos no tiene que ver con dicha cantidad en otro avión, es razonable usar la gráfica de control para el número total de defectos por unidad de inspección, la cual en este caso es **un único avión** obteniendo así 25 unidades de inspección diferentes e independientes.

Sea $X:$ Número total de remaches sin colocar en un avión

$$
X \sim Poisson(c) \Leftrightarrow P(X=x) = \frac{c^x e^{-c}}{x!}
$$
El parámetro $c$ de la distribución Poisson se estima con el número de remaches promedio en los 25 aviones, esto es

$$
\bar{c} = \frac{1}{25}\sum_{i=1}^{25}x_i \\ 
$$

$$
X_i: \text{Número total de remaches sin colocar en el }i \text{-ésimo avión,} \ i\in \{1, \cdots,25\} \\
$$
A continuación se presentan los límites de control para el número de remaches sin colocar en un avión

\begin{table}[H]
\centering
\caption{Límites de control para el número de remaches sin colocar}
\begin{tabular}{|c|c|c|c|}
\hline
LCL & CL & UCL \\ \hline
$\bar{c} - 3 \sqrt{\bar{c}}$   & $\bar{c}$  & $\bar{c} + 3 \sqrt{\bar{c}}$   \\ \hline
\end{tabular}
\end{table}

\subsection{Gráficas de control para el número de remaches sin colocar (c)}

Una vez identificada la gráfica de control adecuada para la situación presentada, se realizan los gráficos de control teniendo en cuenta que si algún punto se sale de los límites se supondra que es debido a causas asignable y la gráfica será reajustada sin dicha observación particular.

```{r control1, fig.cap="Gráfica de control para el número de remaches"}
#qcc(remaches$Remaches[-9], sizes = 1, type = "c")
c_bar <- sum(remaches$Remaches)/dim(remaches)[1]
LCL_remaches <- c_bar - 3*sqrt(c_bar)
UCL_remaches <- c_bar + 3*sqrt(c_bar)

lims <- c(LCL_remaches, c_bar, UCL_remaches)
labels <- c(as.character(round(lims, 4)),  "LCL", "CL", "UCL")

control_lines <- data.frame(x = c(rep(0, 3), rep(26, 3)),
                            y = rep(lims, 2),
                            text = labels)
remaches <- remaches %>% 
  mutate(Estado = if_else(between(Remaches, LCL_remaches, UCL_remaches),
                          "Inside", "Outside"))

ggplot(remaches, aes(Avion, Remaches)) +
  geom_line() +
  geom_point(aes(col = Estado)) +
  geom_hline(yintercept = lims, linetype = "dashed") +
  scale_x_continuous(breaks = 1:25) +
  scale_color_manual(values = c("black", "red")) +
  geom_label(aes(x = x, y = y, label = text), control_lines) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none")
```

Se puede apreciar que el número de remaches en el avión 9 está por fuera de los límites de control por lo que es necesario excluirlo del análisis y recalcular los límites

```{r control2, fig.cap="Gráfica de control para el número de remaches sin la observación 9"}
# Se quita la observacion 9
remaches2 <- remaches[-9, ]
c_bar2 <- sum(remaches2$Remaches)/dim(remaches2)[1]
LCL_remaches2 <- c_bar2 - 3*sqrt(c_bar2)
UCL_remaches2 <- c_bar2 + 3*sqrt(c_bar2)

lims2 <- c(LCL_remaches2, c_bar2, UCL_remaches2)
labels2 <- c(as.character(round(lims2, 4)),  "LCL", "CL", "UCL")

control_lines2 <- data.frame(x = c(rep(0, 3), rep(26, 3)),
                            y = rep(lims2, 2),
                            text = labels2)
remaches2 <- remaches2 %>% 
  mutate(Estado =
           if_else(between(Remaches, LCL_remaches2, UCL_remaches2),
                          "Inside", "Outside"))

ggplot(remaches2, aes(Avion, Remaches)) +
  geom_line() +
  geom_point(aes(col = Estado)) +
  geom_hline(yintercept = lims2, linetype = "dashed") +
  scale_x_continuous(breaks = 1:25) +
  scale_color_manual(values = c("black", "red")) +
  geom_label(aes(x = x, y = y, label = text), control_lines2) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none")
```

En esta nueva gráfica se aprecia que luego de eliminar la observación 9, el proceso se encuentra en control debido a que ningún punto se sale de los límites de control y por la inexistencia de patrones sistemáticos por lo que se puede comenzar con la fase II del proceso.

\subsection{Curva de operación característica (OC)}

Luego de averiguar como luce el proceso en control, se realiza la curva de operación característica del proceso

```{r OC-Aviones, fig.cap="Curva de operación del proceso"}
c <- seq(0, 50, 0.02)
ls <- ppois(UCL_remaches2, c)
li <- ppois(LCL_remaches2, c)
beta <- ls-li

ggplot(mapping = aes(c, beta)) +
  geom_line() +
  geom_vline(xintercept = c_bar2, linetype = "dashed") +
  labs(title = "Curva de operación característica (OC)",
       y = expression(beta)) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) 
```

* La probabilidad de no detectar el cambio en el número promedio de remaches en un avión cuando en realidad hubo cambios, es menor a 0.25 para valores de c menores a 5 o mayores a 37 aproximadamente.
* Para valores de $c \in (10, 30)$ la probabilidad de cometer error tipo II es mayor o igual a 0.75.
* Para valores de c aproximadamente mayores a 45, el proceso tiene la capacidad de detectar el cambios de forma rápida.

\subsection{Calificación del proceso}

<!-- Simon -->

\section{Ejercicio 3}

\section{Ejercicio 4}

<!-- Gaviria -->

\section{Ejercicio 5}



